<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulário de Checklist</title>
  <link rel="manifest" href="/transbordo/manifest.json">
  <style>
    /* Estilos básicos de reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Estilos para o logotipo */
    .logo {
      max-width: 100%;
      height: auto;
    }

    /* Estilos para o cabeçalho */
    header {
      text-align: center;
      padding: 20px;
      background-color: #f0f0f0;
    }

    /* Estilos para o título */
    h1 {
      margin-top: 0;
    }

    /* Estilos para o formulário */
    form {
      max-width: 400px;
      margin: 20px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    /* Estilos responsivos */
    @media (max-width: 768px) {
      form {
        margin: 20px;
      }
    }

    label,
    input,
    select,
    textarea,
    button {
      width: 100%;
      margin-bottom: 10px;
      display: block;
    }

    .observacao,
    .hora {
      width: 100%;
    }

    button,
    input[type="submit"] {
      padding: 10px;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover,
    input[type="submit"]:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>
  <header>
    <img class="logo" src="logotipo.png" alt="Logotipo da sua empresa">
    <h1>Monitoramento Transbordo</h1>
  </header>


<form method="post" onsubmit="enviarDados(event)">
  <label for="data">Data:</label>
  <input type="date" id="data" name="data">

  <label for="funcionario">Funcionário:</label>
  <input type="text" id="funcionario" name="funcionario">

  <label for="periodo">Período:</label>
  <select id="periodo" name="periodo">
    <option value="">Selecione um período</option>
    <option value="Diurno">Diurno</option>
    <option value="Noturno">Noturno</option>
  </select>

  <!-- Repita este bloco para cada ocorrência -->
  <div class="ocorrencia">
    <select name="ocorrencia1">
      <!-- Opções omitidas para brevidade -->
    </select>
    <input type="time" name="horaOcorrencia1" class="hora">
    <textarea name="observacaoOcorrencia1" class="observacao" placeholder="Observação"></textarea>
  </div>
  <!-- Repita este bloco para até 5 ocorrências -->

  <!-- Botões -->
  <button onclick="exportarCSV()">Exportar CSV</button>
  <input type="submit" value="Enviar">
</form>

<!-- Banco de dados -->
<script>

var db;

function abrirBancoDeDados() {
    var request = window.indexedDB.open("ChecklistDB", 1);

    request.onerror = function(event) {
        console.log("Erro ao abrir o banco de dados.");
    };

    request.onupgradeneeded = function(event) {
        db = event.target.result;
        var objectStore = db.createObjectStore("checklist", { keyPath: "id", autoIncrement: true });
        objectStore.createIndex("data", "data", { unique: false });
        objectStore.createIndex("funcionario", "funcionario", { unique: false });
        objectStore.createIndex("periodo", "periodo", { unique: false });
        objectStore.createIndex("ocorrencias", "ocorrencias", { unique: false });
    };

    request.onsuccess = function(event) {
        db = event.target.result;
        console.log("Banco de dados aberto com sucesso.");
    };
}

function salvarDadosNoBanco(dados) {
    var transaction = db.transaction(["checklist"], "readwrite");
    var objectStore = transaction.objectStore("checklist");

    var request = objectStore.add(dados);

    request.onsuccess = function(event) {
        console.log("Dados armazenados com sucesso.");
    };

    request.onerror = function(event) {
        console.log("Erro ao armazenar os dados.");
    };
}

function enviarDados(event) {
    event.preventDefault();

    // Salvar os dados no banco de dados
    var data = document.getElementById("data").value;
    var funcionario = document.getElementById("funcionario").value;
    var periodo = document.getElementById("periodo").value;
    var ocorrencias = [];

    var divs = document.querySelectorAll(".ocorrencia");

    for (var i = 0; i < divs.length; i++) {
    var select = divs[i].querySelector("select");
    var selectedOption = select.options[select.selectedIndex]; // Captura a opção selecionada
    var time = divs[i].querySelector("input[type='time']");
    var textarea = divs[i].querySelector("textarea");

    var ocorrencia = {
        tipo: selectedOption.text, // Agora estamos usando selectedOption.text para obter o texto da opção selecionada
        hora: time.value,
        observacao: textarea.value
    };

    ocorrencias.push(ocorrencia);
}

    var dados = {
        data: data,
        funcionario: funcionario,
        periodo: periodo,
        ocorrencias: ocorrencias
    };

    salvarDadosNoBanco(dados);

    // Feedback para o usuário
    alert("Dados enviados com sucesso!");

    // Limpar formulário
    document.getElementById("data").value = "";
    document.getElementById("funcionario").value = "";
    document.getElementById("periodo").value = "";
    var textareaElements = document.querySelectorAll("textarea");
    for (var i = 0; i < textareaElements.length; i++) {
        textareaElements[i].value = "";
    }
}

// Abrir banco de dados quando a página é carregada
abrirBancoDeDados();

function exportarCSV() {
    // Gerar o arquivo CSV cumulativo
    var transaction = db.transaction(["checklist"], "readonly");
    var objectStore = transaction.objectStore("checklist");
    var request = objectStore.openCursor();
    var csvContent = "Data,Funcionário,Período,Ocorrência,Hora da Ocorrência,Observação\n";

    request.onsuccess = function(event) {
        var cursor = event.target.result;
        if (cursor) {
            var data = cursor.value.data;
            var funcionario = cursor.value.funcionario;
            var periodo = cursor.value.periodo;

            cursor.value.ocorrencias.forEach(function(ocorrencia) {
                csvContent += data + "," + funcionario + "," + periodo + ",";
                csvContent += ocorrencia.tipo + "," + ocorrencia.hora + "," + ocorrencia.observacao + "\n";
            });

            cursor.continue();
        } else {
            var blob = new Blob([csvContent], { type: "text/csv;charset=utf-8" });
            var url = window.URL.createObjectURL(blob);

            var a = document

.createElement("a");
            a.href = url;
            a.download = "checklist.csv";
            document.body.appendChild(a);
            a.click();
        }
    };
}

 
</script>

<!-- Service Worker -->
 <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('/transbordo/serviceworker.js')
        .then(function(registration) {
          console.log('Service Worker registrado com sucesso:', registration);
        })
        .catch(function(error) {
          console.log('Falha ao registrar o Service Worker:', error);
        });
    });
  } else {
    console.log('Service Worker não suportado neste navegador.');
  }
</script>


</body>
</html>
